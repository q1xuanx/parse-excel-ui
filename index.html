<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Info Manager</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #f5f9ff;
      }
      .navbar {
        background-color: #007bff;
      }
      .navbar-brand {
        color: white !important;
        font-weight: 600;
      }
      .card {
        border-radius: 12px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
        margin-bottom: 1rem;
      }
      .btn-custom {
        background-color: #007bff;
        color: white;
        border-radius: 8px;
        transition: background-color 0.2s; /* Thêm transition cho mượt mà hơn */
      }
      .btn-custom:hover {
        background-color: #0056b3;
      }

      /* Responsive table → đổi sang card khi màn hình nhỏ */
      @media (max-width: 768px) {
        /* Đổi thứ tự: Table lên trước Form trên mobile (UX tốt hơn) */
        .order-md-2 {
          order: 2; /* Form */
        }
        .order-md-1 {
          order: 1; /* Table */
        }

        table thead {
          display: none;
        }
        table,
        table tbody,
        table tr,
        table td {
          display: block;
          width: 100%;
        }
        table tr {
          margin-bottom: 1rem;
          border: 1px solid #dee2e6;
          border-radius: 8px;
          padding: 0.75rem;
          background: white;
        }
        table td {
          text-align: left;
          padding: 0.25rem 0;
          border: none;
        }
        table td::before {
          content: attr(data-label);
          font-weight: 600;
          color: #007bff;
          display: block;
          margin-bottom: 2px;
        }
        /* Đảm bảo table container không có padding/margin thừa */
        .table-responsive {
          border: none;
        }
      }
    </style>
  </head>
  <body>
    <nav class="navbar">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">Student Manager</a>
      </div>
    </nav>

    <div class="container mt-4">
      <div class="row">
        <div class="col-md-4 order-md-2">
          <div class="card p-3 sticky-md-top" style="top: 1rem">
            <h5 class="mb-3 text-primary">Thêm học sinh</h5>
            <form id="studentForm">
              <div class="mb-3">
                <label class="form-label">Tên học sinh</label>
                <input
                  type="text"
                  id="nameStudent"
                  class="form-control"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Tuổi</label>
                <input
                  type="number"
                  id="ageStudent"
                  class="form-control"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Tên phụ huynh</label>
                <input
                  type="text"
                  id="nameParent"
                  class="form-control"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Số điện thoại</label>
                <input
                  type="text"
                  id="phoneNumber"
                  class="form-control"
                  required
                />
              </div>
              <button type="submit" class="btn btn-custom w-100">
                Thêm học sinh
              </button>
            </form>
            <div id="responseMessage" class="mt-2"></div>
          </div>
        </div>

        <div class="col-md-8 order-md-1">
          <div class="card p-3">
            <div
              class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-2 gap-2"
            >
              <h5 class="text-primary mb-0">Danh sách học sinh</h5>
              <button class="btn btn-success btn-sm" onclick="exportExcel()">
                Export Excel
              </button>
            </div>
            <div class="table-responsive">
              <table class="table table-bordered table-hover" id="studentTable">
                <thead class="table-primary">
                  <tr>
                    <th>Tên học sinh</th>
                    <th>Tuổi</th>
                    <th>Tên phụ huynh</th>
                    <th>Số điện thoại</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
              <div
                id="noDataMessage"
                class="text-center text-muted py-3 d-none"
              >
                Chưa có học sinh nào. Hãy thêm học sinh mới!
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const apiBase = "https://5a6eb32ec1f3.ngrok-free.app/api/v1";

      async function apiFetch(url, options = {}) {
        options.headers = {
          ...(options.headers || {}),
          "Content-Type": "application/json",
          "ngrok-skip-browser-warning": "true",
        };
        return fetch(url, options);
      }

      document.addEventListener("DOMContentLoaded", loadStudents);

      async function loadStudents() {
        try {
          const res = await apiFetch(apiBase + "/students");
          const txt = await res.text();
          let data;
          try {
            data = JSON.parse(txt);
          } catch {
            console.error("Không parse được JSON, response:", txt);
            return;
          }

          const tbody = document.querySelector("#studentTable tbody");
          const noDataMessage = document.getElementById("noDataMessage");
          tbody.innerHTML = "";

          const students = data.result || data;

          if (students && students.length > 0) {
            students.forEach((s) => {
              const row = `<tr>
                  <td data-label="Tên học sinh">${s.nameStudent}</td>
                  <td data-label="Tuổi">${s.ageStudent}</td>
                  <td data-label="Tên phụ huynh">${s.nameParent}</td>
                  <td data-label="Số điện thoại">${s.phoneNumber}</td>
                </tr>`;
              tbody.innerHTML += row;
            });
            noDataMessage.classList.add("d-none");
          } else {
            noDataMessage.classList.remove("d-none");
          }
        } catch (err) {
          console.error("Error loading students:", err);
        }
      }

      document
        .getElementById("studentForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          const student = {
            nameStudent: document.getElementById("nameStudent").value,
            ageStudent: parseInt(document.getElementById("ageStudent").value),
            nameParent: document.getElementById("nameParent").value,
            phoneNumber: document.getElementById("phoneNumber").value,
          };

          const submitButton = this.querySelector('button[type="submit"]');
          submitButton.disabled = true;
          submitButton.textContent = "Đang xử lý...";
          const responseMessage = document.getElementById("responseMessage");
          responseMessage.innerHTML = "";

          try {
            const res = await apiFetch(apiBase + "/add-student", {
              method: "POST",
              body: JSON.stringify(student),
            });

            const data = await res.json();

            if (!res.ok) {
              throw new Error(data.message || `Lỗi HTTP ${res.status}`);
            }

            responseMessage.innerHTML = `
              <div class="alert alert-success">
                ${data.message}${data.time ? " - " + data.time : ""}
              </div>`;
            loadStudents();
            this.reset();
          } catch (err) {
            responseMessage.innerHTML = `
              <div class="alert alert-danger">Thêm thất bại: ${err.message}</div>`;
          } finally {
            submitButton.disabled = false;
            submitButton.textContent = "Thêm học sinh";
            // Tự động xóa thông báo sau 5 giây
            setTimeout(() => {
              responseMessage.innerHTML = "";
            }, 5000);
          }
        });

      async function exportExcel() {
        const exportButton = document.querySelector(".btn-success.btn-sm");
        const originalText = exportButton.textContent;
        const responseMessage = document.getElementById("responseMessage");

        // 1. Khóa nút và hiển thị trạng thái
        exportButton.disabled = true;
        exportButton.textContent = "Đang xuất...";
        responseMessage.innerHTML = "";

        try {
          // 2. Gọi API POST để tạo file và xóa dữ liệu (BẮT BUỘC)
          const res = await apiFetch(apiBase + "/make-excel", {
            method: "POST",
          });

          if (!res.ok) {
            const errorText = await res.text();
            throw new Error(
              `Tạo file thất bại. HTTP: ${
                res.status
              }. Chi tiết: ${errorText.substring(0, 50)}...`
            );
          }

          const blob = await res.blob();
          const url = window.URL.createObjectURL(blob);
          const filename = "students.xlsx";

          // --- LOGIC TẢI FILE: Tối ưu cho mọi trình duyệt ---

          // Tạo thẻ <a> ảo để kích hoạt download
          const a = document.createElement("a");
          a.href = url;
          a.download = filename;

          // Kích hoạt click
          document.body.appendChild(a);
          a.click();

          // Dọn dẹp
          a.remove();
          window.URL.revokeObjectURL(url);

          // 3. Load lại danh sách học sinh (để hiển thị dữ liệu đã bị xóa)
          loadStudents();

          // 4. Hiển thị thông báo thành công
          responseMessage.innerHTML = `
            <div class="alert alert-success mt-2">Đã xuất file ${filename} thành công!</div>`;
          setTimeout(() => (responseMessage.innerHTML = ""), 5000);
        } catch (err) {
          console.error("Lỗi Export:", err);
          // Hiển thị lỗi ngay trên giao diện
          responseMessage.innerHTML = `
            <div class="alert alert-danger mt-2">Xuất file thất bại: ${err.message}. (Lưu ý: Nếu dùng Safari, hãy đảm bảo bạn không bị chặn pop-up).</div>`;
          setTimeout(() => (responseMessage.innerHTML = ""), 7000);
        } finally {
          // 5. Luôn khôi phục trạng thái nút bấm
          exportButton.disabled = false;
          exportButton.textContent = originalText;
        }
      }
    </script>
  </body>
</html>
