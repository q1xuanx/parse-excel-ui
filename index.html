<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Student Info Manager</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #f8fbff;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }
      .navbar {
        background: linear-gradient(90deg, #007bff, #0056b3);
      }
      .navbar-brand {
        color: white !important;
        font-weight: bold;
        display: flex;
        align-items: center;
      }
      .navbar-brand i {
        margin-right: 8px;
      }
      .card {
        border-radius: 12px;
        border: none;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      }
      .btn-custom {
        background-color: #007bff;
        color: white;
        border-radius: 8px;
        transition: 0.3s;
      }
      .btn-custom:hover {
        background-color: #0056b3;
      }
      .table thead {
        background-color: #007bff;
        color: white;
      }
      .table-hover tbody tr:hover {
        background-color: #eef5ff;
      }
      .form-label {
        font-weight: 500;
      }
      .badge-age {
        background-color: #6c63ff;
        font-size: 0.85rem;
      }
    </style>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">
          <i class="bi bi-mortarboard"></i> Student Manager
        </a>
      </div>
    </nav>

    <div class="container mt-4">
      <div class="row g-4">
        <!-- Input form -->
        <div class="col-md-4">
          <div class="card p-4">
            <h5 class="mb-3 text-primary border-bottom pb-2">
              <i class="bi bi-person-plus"></i> Thêm học sinh
            </h5>
            <form id="studentForm">
              <div class="mb-3">
                <label class="form-label">Tên học sinh</label>
                <input
                  type="text"
                  id="nameStudent"
                  class="form-control"
                  placeholder="Nguyễn Văn A"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Tuổi</label>
                <input
                  type="number"
                  id="ageStudent"
                  class="form-control"
                  min="1"
                  placeholder="10"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Tên phụ huynh</label>
                <input
                  type="text"
                  id="nameParent"
                  class="form-control"
                  placeholder="Nguyễn Văn B"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Số điện thoại</label>
                <input
                  type="text"
                  id="phoneNumber"
                  class="form-control"
                  placeholder="0123456789"
                  required
                />
              </div>
              <button type="submit" class="btn btn-custom w-100">
                <i class="bi bi-plus-circle"></i> Thêm học sinh
              </button>
            </form>
            <div id="responseMessage" class="mt-3"></div>
          </div>
        </div>

        <!-- Table -->
        <div class="col-md-8">
          <div class="card p-4">
            <div
              class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2"
            >
              <h5 class="text-primary mb-0">
                <i class="bi bi-people"></i> Danh sách học sinh
              </h5>
              <button class="btn btn-success btn-sm" onclick="exportExcel()">
                <i class="bi bi-file-earmark-excel"></i> Export Excel
              </button>
            </div>
            <div class="table-responsive">
              <table
                class="table table-bordered table-hover align-middle text-center"
                id="studentTable"
              >
                <thead>
                  <tr>
                    <th>Tên học sinh</th>
                    <th>Tuổi</th>
                    <th>Tên phụ huynh</th>
                    <th>Số điện thoại</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- data render here -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />

    <script>
      const apiBase = "https://5a6eb32ec1f3.ngrok-free.app/api/v1";

      // Wrapper fetch có kèm header ngrok
      async function apiFetch(url, options = {}) {
        options.headers = {
          ...(options.headers || {}),
          "Content-Type": "application/json",
          "ngrok-skip-browser-warning": "true",
        };
        return await fetch(url, options);
      }

      // Load students on page load
      document.addEventListener("DOMContentLoaded", loadStudents);

      async function loadStudents() {
        try {
          const res = await apiFetch(apiBase + "/students");
          const txt = await res.text();
          let data;
          try {
            data = JSON.parse(txt);
          } catch {
            console.error("Không parse được JSON, response:", txt);
            return;
          }

          const tbody = document.querySelector("#studentTable tbody");
          tbody.innerHTML = "";

          const students = data.result || data;
          students.forEach((s) => {
            const row = `<tr>
              <td>${s.nameStudent}</td>
              <td><span class="badge badge-age">${s.ageStudent}</span></td>
              <td>${s.nameParent}</td>
              <td>${s.phoneNumber}</td>
            </tr>`;
            tbody.innerHTML += row;
          });
        } catch (err) {
          console.error("Error loading students:", err);
        }
      }

      // Handle form submit
      document
        .getElementById("studentForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          const student = {
            nameStudent: document.getElementById("nameStudent").value,
            ageStudent: parseInt(document.getElementById("ageStudent").value),
            nameParent: document.getElementById("nameParent").value,
            phoneNumber: document.getElementById("phoneNumber").value,
          };

          try {
            const res = await apiFetch(apiBase + "/add-student", {
              method: "POST",
              body: JSON.stringify(student),
            });
            if (!res.ok) throw new Error("HTTP " + res.status);
            const data = await res.json();

            document.getElementById("responseMessage").innerHTML = `
            <div class="alert alert-success">
              ${data.message}${data.time ? " - " + data.time : ""}
            </div>`;
            loadStudents();
            this.reset();
          } catch (err) {
            document.getElementById("responseMessage").innerHTML = `
            <div class="alert alert-danger">Thêm thất bại: ${err.message}</div>`;
          }
        });

      // Export excel
      async function exportExcel() {
        try {
          const res = await apiFetch(apiBase + "/make-excel", {
            method: "POST",
          });
          const blob = await res.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "students.xlsx";
          document.body.appendChild(a);
          a.click();
          a.remove();
          loadStudents();
        } catch (err) {
          console.error("Export error:", err);
        }
      }
    </script>
  </body>
</html>
